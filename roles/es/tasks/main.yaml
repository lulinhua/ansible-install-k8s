- name: initialize dir
  file: name={{ item }} state=directory mode=0755
  with_items:
  - "{{ java_dir }}"

- name: sync jdk
  synchronize: src=dir/{{ item }} dest={{ java_dir }}
  with_items:
  - "jdk"

- name:  ln -sf {{ java_dir }}/jdk/bin/java /usr/bin/java
  shell: ln -sf {{ java_dir }}/jdk/bin/java /usr/bin/java

- name:  sync env
  template: src=env/{{ item }} dest=/etc/profile.d/{{ item }}
  with_items:
  - "jdk.sh"

- name: add user es
  user: name=es shell=/bin/bash append=yes

- name: sync es
  synchronize: src=dir/{{ item }} dest=/opt
  with_items:
  - "elasticsearch"

- name:  sync config
  template: src=config/{{ item }} dest={{ es_dir }}config/{{ item }}
  with_items:
  - "elasticsearch.yml"

- name: delete bat
  shell: find {{ item }} -name *.bat |xargs rm
  with_items:
  - "{{ es_dir }}"
  ignore_errors: true

- name: sync limits.conf
  copy: src=limits.conf dest=/etc/security/limits.conf

- name: sync sysctl es.conf
  copy: src=sysctl.d/es.conf dest=/etc/sysctl.d/es.conf

- name: sysctl -p /etc/sysctl.d/es.conf
  shell: sysctl -p /etc/sysctl.d/es.conf

# python -m SimpleHTTPServer
- name: git clone elasticsearch-head
  git: repo=https://github.com/mobz/elasticsearch-head
       dest={{ es_head_dir }}
  ignore_errors: true

- name: git clone bigdesk
  git: repo=https://github.com/hlstudio/bigdesk
       dest={{ es_bigdesk_dir }}
  ignore_errors: true

- name: install nodejs
  yum: name={{ item }} state=latest
  with_items:
  - "nodejs"
  ignore_errors: true

- name: npm install grunt
  shell: npm install -g {{ item }} --registry=https://registry.npm.taobao.org
  with_items:
  - "grunt"
  ignore_errors: true

- name: directory owner for es
  file: name={{ item }} state=directory mode=0755 owner=es group=es recurse=yes
  with_items:
  - "{{ es_dir }}"
  - "{{ es_head_dir }}"
  - "{{ es_bigdesk_dir }}"

- name: start es
  shell: su - es -c "{{ es_dir }}bin/elasticsearch -d"
